server loadgen-client {

    namespace = radius

    listen load {
        #
		#  The main module is the proto module, even though we're
		#  operating in the RADIUS namespace.
		#
        handler = load

        #
		#  This is a valid Packet-Type for the current `namespace`
		#
		type = Access-Request

        #
        # (Optional) and as indicated in the source code:
	    #   For performance tweaking.  NOT for normal humans.
	    #
        # max_packet_size = 4096
        # num_messages = 1
        # priority       = 0

        #
		#  For now, only 'step' transport is available.
		#
        # process by proto_load_step.c
        #####################################################################
        transport = step
        step {

            # - filename (required)
            #     Path to the file containing the template packet / attributes to send.
            #     Must exist, be readable, and non-empty.
            # - csv (optional)
            #     Path to a CSV file where per-socket stats will be written periodically (optional).
            # - max_attributes
            #     Maximum number of attributes to decode from the input packet.
            #     Default: RADIUS_MAX_ATTRIBUTES.
            # - start_pps
            #     Initial packets-per-second rate for the generator. (Field load.start_pps.)
            # - max_pps
            #     Maximum PPS the generator will ramp up to. (load.max_pps.)
            # - duration
            #     Duration (in seconds) of the load run at each step / overall, depending on how you drive it. (load.duration.)
            # - step
            #     Increment step for PPS between adjustments (e.g. increase by N PPS each interval). (load.step.)
            # - max_backlog
            #     Maximum backlog in milliseconds, mapped to load.milliseconds – effectively a cap on outstanding work / queue depth in time.
            # - parallel
            #     Degree of parallelism (how many generator threads/flows). (load.parallel.)
            # - repeat
            #     Boolean: whether to repeat the sequence from filename when it reaches the end. (repeat in proto_load_step_t.)

            filename = ${confdir}/load-generator-tests/pap_1packet.req

            # optional CSV stats output file
            csv = ${confdir}/stats/load-generator-client-stats.csv

            #
            # Safety limit on attributes per packet
            #
            max_attributes = 64

            #
            # Load profile for this step
            #
            # start_pps: initial packets per second
            # max_pps  : maximum packets per second we’ll ramp to
            # duration : how long to run this step (seconds)
            # step     : increment in PPS per "tick" (0 = flat load)
            #
            start_pps = 1
            max_pps   = 1
            duration  = 1

            #
			#  How big of a packet/s step to jump after running each test.
			#
            step = 0

            #
			#  We don't want to overload the server.  If
			#  the server cannot process packets quickly
			#  enough, we will get a backlog of
			#  unprocessed packets.  If the backlog gets
			#  too high, then the load generator will
			#  temporarily stop sending packets.  Once the
			#  backlog is low enough, it will continue.
			#
			max_backlog	= 1000

			#
			#  How many packets to send immediately in
			#  parallel, without waiting for a response.
			#  When a reply is received, a new request may
			#  be sent.
			#
            parallel = 1

            repeat = no
        }

    }

    #
    #  The rest of the recv/send sections are protocol specific, and are
    #  taken from the `namespace`.
    #
#    recv Access-Request {
#        # Optional: use unlang to modify packet before calling radius module to send
#        # requests to the upstream RADIUS server(s).
#
#        # Use the radius module to send the request to the upstream RADIUS server(s).
#        radius
#        if (ok) {
#            accept
#        }   
#    }
#
#    authenticate radius {
#        radius
#    }

    recv Access-Request {
        # Optional: use unlang to modify packet before calling radius module to send
        # requests to the upstream RADIUS server(s).

        # The Auth-Type value is specifically set to use the load-generator-proxy authenticate logic
        control.Auth-Type := "load-generator-proxy"
    }

    authenticate load-generator-proxy {
        # The Auth-Type value is specifically set to use the load-generator-proxy authenticate logic
        # The radius module udp { ... } configuration defines where the requests are sent; refer
        # to mods-available/radius for that configuration.
        radius
    }

    send Access-Accept {
        %linelog("load-generator: send Access-Accept STARTED")
        ok
    }

    send Access-Reject {
        %linelog("load-generator: send Access-Reject STARTED")
        ok
    }

}
